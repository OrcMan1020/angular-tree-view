angular.module("TreeView",[]).provider("treeViewConfig",function(){var e=this;this.options={iconLeaf:"fa fa-file glyphicon glyphicon-file",iconExpand:"fa fa-minus glyphicon glyphicon-minus",iconCollapse:"fa fa-plus glyphicon glyphicon-plus",template:['<ul class="tree-view-group">','<li ng-repeat="data in data[children]"','ng-class="{expanded: isExpanded(data)}"','ng-if="!filterModel || isFiltered(data)">','<span class="tree-icon" ng-class="getExpandIcon(data)" ng-click="toggleExpanded(data, $event)"></span>','<a ng-class="{checked: isChecked(data), indetermine: !isChecked(data) && childrenChecked(data)}"','ng-click="toggleChecked(data, $event)">',"<tree-view-transclude></tree-view-transclude>","</a>","<tree-view-item",'ng-if="data[children] && isExpanded(data)"',"></tree-view-item>","</li>","</ul>"].join(" ")},this.$get=function(){return e.options}}).directive("treeViewItem",function(){return{require:"^treeView",link:function(e,t,n,i){i.template(e,function(e){t.empty().append(e)})}}}).directive("treeViewTransclude",function(){return{link:function(e,t){e.transcludeScope=e.parentScopeOfTree.$new(),e.transcludeScope.node=e.data,e.transcludeScope.$index=e.$index,e.transcludeScope.$first=e.$first,e.transcludeScope.$middle=e.$middle,e.transcludeScope.$last=e.$last,e.transcludeScope.$odd=e.$odd,e.transcludeScope.$even=e.$even,e.$on("$destroy",function(){e.transcludeScope.$destroy()}),e.$treeTransclude(e.transcludeScope,function(e){t.empty().append(e)})}}}).directive("treeView",["treeViewConfig",function(e){return{scope:{outputAllInfo:"=",datas:"=inputModel",ngModel:"=",filterModel:"=",recursionCheck:"=",outputDuplicate:"=",singleMode:"=",options:"=",hashObject:"=",enableCheck:"="},transclude:!0,link:function(e,t,n,i,a){i.template(e,function(e){t.empty().append(e)}),e.$treeTransclude=a},controller:["$scope","$element","$attrs","$compile",function(t,n,i,a){var r=0;t.parentScopeOfTree=t.$parent,t.options=t.options||{},t.displayProperty=t.options.displayProperty||"text",t.valueProperty=t.options.valueProperty||"id",t.children=t.options.childrenProperty||"children",t.iconLeaf=t.options.iconLeaf||e.iconLeaf,t.iconExpand=t.options.iconExpand||e.iconExpand,t.iconCollapse=t.options.iconCollapse||e.iconCollapse,t.iconCheck=t.options.iconCheck||e.iconCheck,t.iconUnCheck=t.options.iconUnCheck||e.iconUnCheck,this.template=a(e.template);var c={arrayMinus:function(e,t){e=e||[],t=t||[];for(var n=[],i=0;i<e.length;i++)-1===this.find(t,e[i])&&n.push(e[i]);return n},find:function(e,n){if(angular.isObject(n)){for(var i=0;i<e.length;i++)if(n[t.valueProperty]===e[i][t.valueProperty])return i;return-1}return e.indexOf(n)},shallowMinus:function(e,t){for(var n=0;n<e.length;n++)-1!==t.indexOf(e[n])&&(e.splice(n,1),n--)}},l={modelInited:!1,inited:!1,init:function(e){n.addClass("tree-view"),this.transformDataToTree(e),t.data={},t.data[t.children]=e,this.inited||this.bindEvents(),this.inited=!0,this.modelInited=!1},unwrap:function(e){for(var n=0;n<e.length;n++)e[n]=e[n][t.valueProperty]},updateModelByCheck:function(e,n,i){t.outputAllInfo||this.unwrap(e),n===!0?(t.ngModel=t.ngModel||[],Array.prototype.push.apply(t.ngModel,e)):c.shallowMinus(t.ngModel,e),t.outputDuplicate||(n===!0&&this.deleteDuplicated(t.ngModel),n===!1&&this.fillResult(t.ngModel,e,i))},fillResult:function(e,n,i){for(var a=[],r=i;r.$treeView.parentData;){var c=this.getParentItem(r);if(-1===n.indexOf(c))break;a.push(r),r=r.$treeView.parentData}if(a.length)for(var l=0;l<a.length;l++){var o=[].concat(a[l].$treeView.parentData[t.children]);o.splice(o.indexOf(a[l]),1),t.outputAllInfo||this.unwrap(o),Array.prototype.push.apply(e,o)}},deleteDuplicated:function(e){for(var n=[],i=0;i<e.length;i++){var a;t.outputAllInfo?a=e[i].$treeView.parentData:(a=this.hashObject[e[i]].$treeView.parentData,a=a&&a[t.valueProperty]),-1!==e.concat(n).indexOf(a)&&(n=n.concat(e.splice(i,1)),i--)}},updateStateByModelChange:function(e,n){var i;this.modelInited?i=c.arrayMinus(e,n):(i=e,this.modelInited=!0);for(var a=c.arrayMinus(n,e),r=0;r<i.length;r++){var l=t.outputAllInfo?i[r]:this.hashObject[i[r]];l.$treeView.isChecked=!0,this.expandUp(l)}for(r=0;r<a.length;r++)l=t.outputAllInfo?a[r]:this.hashObject[a[r]],!t.outputDuplicate&&l.$treeView.parentData&&l.$treeView.parentData.$treeView.isChecked||(l.$treeView.isChecked=!1,t.outputDuplicate||e.length&&(1!==a.length||i.length)||this.calculateDown(l));t.outputDuplicate||e.length!==this.currentLength||this.deleteDuplicated(t.ngModel)},expandUp:function(e){var t=e.$treeView.parentData;t&&!t.$treeView.isExpanded&&(t.$treeView.isChecked?this.expandUp(t):(t.$treeView.isExpanded=!0,this.expandUp(t)))},getParentItem:function(e){var n,i=angular.isObject(e)?e:this.hashObject[e];return t.outputAllInfo?n=e.$treeView.parentData:(n=i.$treeView.parentData,n=n&&n[t.valueProperty]),n},calculateChecked:function(e,t){this.calculateDown(e,t),this.calculateUp(e,t)},calculateDown:function(e,n){if(e[t.children])for(var i=0;i<e[t.children].length;i++)e[t.children][i].$treeView.isChecked!==e.$treeView.isChecked&&(n&&n.push(e[t.children][i]),e[t.children][i].$treeView.isChecked=e.$treeView.isChecked,this.calculateDown(e[t.children][i]))},calculateUp:function(e,n){if(e.$treeView.parentData&&e.$treeView.parentData.$treeView.isChecked!==e.$treeView.isChecked){for(var i=!!e.$treeView.parentData.$treeView.isChecked,a=0,r=0;r<e.$treeView.parentData[t.children].length;r++)e.$treeView.parentData[t.children][r].$treeView.isChecked&&a++;e.$treeView.parentData.$treeView.isChecked=a===r,e.$treeView.parentData.$treeView.isChecked!==i&&(n&&n.push(e.$treeView.parentData),this.calculateUp(e.$treeView.parentData))}},hashObject:{},currentLength:0,transformDataToTree:function(e){var n=[];this.hashObject={};for(var a=0;a<e.length;a++)n.push(e[a]);for(;n.length;){var c=n.pop();if(c.$treeView=c.$treeView||{},t.valueProperty in c||(c[t.valueProperty]=r++),this.currentLength++,this.hashObject[c[t.valueProperty]]=c,c[t.children]&&c[t.children].length)for(a=0;a<c[t.children].length;a++){var l=c[t.children][a];l.$treeView=l.$treeView||{},l.$treeView.parentData=c,n.push(l)}}i.hashObject&&(t.hashObject=this.hashObject)},bindEvents:function(){var e=this;t.singleMode?t.$watch("ngModel",function(t,n){e.updateStateByModelChange(t,n)}):t.$watchCollection("ngModel",function(t,n){t=t||[],n=n||[],e.updateStateByModelChange(t,n)}),t.$watch("filterModel",function(n,i){if(n){var a=[];angular.forEach(e.hashObject,function(e,i){-1!==e[t.displayProperty].toString().indexOf(n)?a.push(e):e.$treeView.isFiltered=!1});for(var r=0;r<a.length;r++)a[r].$treeView.isFiltered=!0,e.filtUp(a[r]),e.expandUp(a[r])}})},filtUp:function(e){e.$treeView.parentData&&!e.$treeView.parentData.isFiltered&&(e.$treeView.parentData.isFiltered=!0,this.filtUp(e.$treeView.parentData))}};t.getExpandIcon=function(e){return e[t.children]&&e[t.children].length?e.$treeView.isExpanded?t.iconExpand:t.iconCollapse:t.iconLeaf},t.toggleExpanded=function(e,t){e.$treeView.isExpanded=!e.$treeView.isExpanded,t.stopPropagation()},t.isExpanded=function(e){return!!e.$treeView.isExpanded},t.isChecked=function(e){return!!e.$treeView.isChecked},t.childrenChecked=function(e){if(!e[t.children]||!e[t.children].length)return!1;for(var n=[],i=e[t.children],a=0;a<i.length;a++)n.push(i[a]);for(;n.length;){var r=n.pop();if(r.$treeView.isChecked)return!0;if(r.children&&r.children.length)for(a=0;a<r.children.length;a++)n.push(r.children[a])}return!1},t.toggleChecked=function(e){var n=t.isChecked(e),i=[e];t.singleMode&&l.initCheck(),e.$treeView.isChecked=!n,t.recursionCheck&&l.calculateChecked(e,i),l.updateModelByCheck(i,e.$treeView.isChecked,e)},t.isFiltered=function(e){return!!e.$treeView.isFiltered},t.isCheckable=function(){return t.enableCheck!==!1},t.$watch("datas",function(e,t){angular.isDefined(e)&&l.init(e)})}]}}]);